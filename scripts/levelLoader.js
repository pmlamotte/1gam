"use strict";

window.loadLevel = function (levelName, callback) {
	$.getJSON("maps/" + levelName + ".json", function (levelData) {
		loadTextures(levelData, callback);
	}).fail(function () {
		console.error("failed to retrieve data for level '" + levelName + "'");
	});
};

function loadTextures(level, cb) {
	level.tilesets = _.map(level.tilesets, genTileset);
	var imageAssets = getAssetsFromLevel(level);
	textureFactory.load(imageAssets, function () {
		var entities = genLayers(level);
		cb(entities);
	});
}

function genLayers(levelData) {
	return _.reduce(levelData.layers, function (accum, layer) {
		return accum.concat(genLayer(layer, levelData));
	}, []);
}

function genLayer(layer, levelData) {
	var entities = [];
	var tiles = getTiles(levelData);
	if (!_.isUndefined(layer.data)) {
		for (var j = 0; j < layer.height; j++) {
			for (var i = 0; i < layer.width; i++) {
				var tileNum = i + j * layer.width;
				var tileId = layer.data[tileNum];
				if (tileId !== 0) {
					var tileData = tiles[tileId];
					entities.push(genTile(tileData, levelData, i, j));
				}
			}
		}
	}
	return entities;
}

function genTile(tile, levelData, i, j) {
	var baseEntity = new BaseEntity(_.extend({
		position: {
			x: levelData.tilewidth * i + 200,
			y: levelData.tileheight * j + 200
		}
	}, tile.properties));
	var sprite = new SpriteComponent(undefined, tile.gid);
	if (tile.properties.collide) {
		baseEntity.addComponent(new SpritePhysicsComponent());
	}
	baseEntity.addComponent(sprite);
	return baseEntity;
}

function getTiles(level) {
	return _(level.tilesets).map(function (tileset) {
		return tileset.tiles;
	}).reduce(_.extend, {});
}

function convertToBools(properties) {
	return _.mapValues(properties, function (value) {
		return value === "true" ? true : value === "false" ? false : value;
	});
}

function getTileProperties(tileset, tileId) {
	var properties = undefined;
	if (_.isUndefined(tileset.tileproperties) || _.isUndefined(tileset.tileproperties[tileId])) {
		properties = {};
	} else {
		properties = tileset.tileproperties[tileId];
	}

	return convertToBools(properties);
}

function genTileset(tileset) {
	tileset = _.extend({}, tileset);
	tileset.image = tileset.image.replace("../", "");

	tileset.numTilesWidth = Math.floor(tileset.imageheight / tileset.tileheight);
	tileset.numTilesHeight = Math.floor(tileset.imagewidth / tileset.tilewidth);
	tileset.tilecount = tileset.numTilesWidth * tileset.numTilesHeight;
	tileset.lastgid = tileset.firstgid + tileset.tilecount;

	tileset.tiles = _(_.range(tileset.firstgid, tileset.lastgid)).map(function (tileId) {
		return {
			gid: tileId,
			properties: getTileProperties(tileset, tileId - tileset.firstgid),
			x: (tileId - tileset.firstgid) % tileset.numTilesWidth,
			y: Math.floor((tileId - tileset.firstgid) / tileset.numTilesHeight)
		};
	}).reduce(function (accum, tile) {
		accum[tile.gid] = tile;
		return accum;
	}, {});
	return tileset;
}

function getAssetsFromLevel(level) {
	return _.map(level.tilesets, function (tileset) {
		return _.extend({
			path: tileset.image,
			id: tileset.name,
			tileDimensions: {
				x: tileset.numTilesWidth,
				y: tileset.numTilesHeight,
				width: tileset.tilewidth,
				height: tileset.tileheight,
				baseId: tileset.firstgid
			}
		}, tileset);
	});
}
//# sourceMappingURL=data:application/json;base64,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O0dBQ25FLENBQUM7RUFDRixDQUFDLENBQ0QsTUFBTSxDQUFDLFVBQVMsS0FBSyxFQUFFLElBQUksRUFBRTtBQUM3QixPQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztBQUN2QixTQUFPLEtBQUssQ0FBQztFQUNiLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDUixRQUFPLE9BQU8sQ0FBQztDQUNmOztBQUVELFNBQVMsa0JBQWtCLENBQUMsS0FBSyxFQUFFO0FBQ2xDLFFBQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFVBQVMsT0FBTyxFQUFFO0FBQzlDLFNBQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNmLE9BQUksRUFBRSxPQUFPLENBQUMsS0FBSztBQUNuQixLQUFFLEVBQUUsT0FBTyxDQUFDLElBQUk7QUFDaEIsaUJBQWMsRUFBRTtBQUNmLEtBQUMsRUFBRSxPQUFPLENBQUMsYUFBYTtBQUN4QixLQUFDLEVBQUUsT0FBTyxDQUFDLGNBQWM7QUFDekIsU0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTO0FBQ3hCLFVBQU0sRUFBRSxPQUFPLENBQUMsVUFBVTtBQUMxQixVQUFNLEVBQUUsT0FBTyxDQUFDLFFBQVE7SUFDeEI7R0FDRCxFQUFFLE9BQU8sQ0FBQyxDQUFDO0VBQ1osQ0FBQyxDQUFDO0NBQ0giLCJmaWxlIjoibGV2ZWxMb2FkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ3aW5kb3cubG9hZExldmVsID0gZnVuY3Rpb24obGV2ZWxOYW1lLCBjYWxsYmFjaykge1xuXHQkLmdldEpTT04oYG1hcHMvJHtsZXZlbE5hbWV9Lmpzb25gLCBmdW5jdGlvbihsZXZlbERhdGEpIHtcblx0XHRsb2FkVGV4dHVyZXMobGV2ZWxEYXRhLCBjYWxsYmFjayk7XG5cdH0pLmZhaWwoZnVuY3Rpb24oKSB7XG5cdFx0Y29uc29sZS5lcnJvcihgZmFpbGVkIHRvIHJldHJpZXZlIGRhdGEgZm9yIGxldmVsICcke2xldmVsTmFtZX0nYCk7XG5cdH0pO1xufTtcblxuZnVuY3Rpb24gbG9hZFRleHR1cmVzKGxldmVsLCBjYikge1xuXHRsZXZlbC50aWxlc2V0cyA9IF8ubWFwKGxldmVsLnRpbGVzZXRzLCBnZW5UaWxlc2V0KTtcblx0dmFyIGltYWdlQXNzZXRzID0gZ2V0QXNzZXRzRnJvbUxldmVsKGxldmVsKTtcblx0dGV4dHVyZUZhY3RvcnkubG9hZChpbWFnZUFzc2V0cywgZnVuY3Rpb24oKSB7XG5cdFx0dmFyIGVudGl0aWVzID0gZ2VuTGF5ZXJzKGxldmVsKTtcblx0XHRjYihlbnRpdGllcyk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBnZW5MYXllcnMobGV2ZWxEYXRhKSB7XG5cdHJldHVybiBfLnJlZHVjZShsZXZlbERhdGEubGF5ZXJzLCAoYWNjdW0sIGxheWVyKSA9PiBhY2N1bS5jb25jYXQoZ2VuTGF5ZXIobGF5ZXIsIGxldmVsRGF0YSkpLCBbXSk7XG59XG5cbmZ1bmN0aW9uIGdlbkxheWVyKGxheWVyLCBsZXZlbERhdGEpIHtcblx0dmFyIGVudGl0aWVzID0gW107XG5cdHZhciB0aWxlcyA9IGdldFRpbGVzKGxldmVsRGF0YSk7XG5cdGlmICghXy5pc1VuZGVmaW5lZChsYXllci5kYXRhKSkge1xuXHRcdGZvciAodmFyIGogPSAwOyBqIDwgbGF5ZXIuaGVpZ2h0OyBqKyspIHtcblx0XHRcdGZvciAodmFyIGkgPSAwOyBpIDwgbGF5ZXIud2lkdGg7IGkrKykge1xuXHRcdFx0XHR2YXIgdGlsZU51bSA9IChpICsgaiAqIGxheWVyLndpZHRoKTtcblx0XHRcdFx0dmFyIHRpbGVJZCA9IGxheWVyLmRhdGFbdGlsZU51bV07XG5cdFx0XHRcdGlmICh0aWxlSWQgIT09IDApIHtcblx0XHRcdFx0XHR2YXIgdGlsZURhdGEgPSB0aWxlc1t0aWxlSWRdO1xuXHRcdFx0XHRcdGVudGl0aWVzLnB1c2goZ2VuVGlsZSh0aWxlRGF0YSwgbGV2ZWxEYXRhLCBpLCBqKSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblx0cmV0dXJuIGVudGl0aWVzO1xufVxuXG5mdW5jdGlvbiBnZW5UaWxlKHRpbGUsIGxldmVsRGF0YSwgaSwgaikge1xuXHR2YXIgYmFzZUVudGl0eSA9IG5ldyBCYXNlRW50aXR5KF8uZXh0ZW5kKHtcblx0XHRwb3NpdGlvbjoge1xuXHRcdFx0eDogbGV2ZWxEYXRhLnRpbGV3aWR0aCAqIGkgKyAyMDAsXG5cdFx0XHR5OiBsZXZlbERhdGEudGlsZWhlaWdodCAqIGogKyAyMDBcblx0XHR9XG5cdH0sIHRpbGUucHJvcGVydGllcykpO1xuXHR2YXIgc3ByaXRlID0gbmV3IFNwcml0ZUNvbXBvbmVudCh1bmRlZmluZWQsIHRpbGUuZ2lkKTtcblx0aWYgKHRpbGUucHJvcGVydGllcy5jb2xsaWRlKSB7XG5cdFx0YmFzZUVudGl0eS5hZGRDb21wb25lbnQobmV3IFNwcml0ZVBoeXNpY3NDb21wb25lbnQoKSk7XG5cdH1cblx0YmFzZUVudGl0eS5hZGRDb21wb25lbnQoc3ByaXRlKTtcblx0cmV0dXJuIGJhc2VFbnRpdHk7XG59XG5cbmZ1bmN0aW9uIGdldFRpbGVzKGxldmVsKSB7XG5cdHJldHVybiBfKGxldmVsLnRpbGVzZXRzKS5tYXAoZnVuY3Rpb24odGlsZXNldCkge1xuXHRcdHJldHVybiB0aWxlc2V0LnRpbGVzO1xuXHR9KS5yZWR1Y2UoXy5leHRlbmQsIHt9KTtcbn1cblxuZnVuY3Rpb24gY29udmVydFRvQm9vbHMocHJvcGVydGllcykge1xuXHRyZXR1cm4gXy5tYXBWYWx1ZXMocHJvcGVydGllcywgZnVuY3Rpb24odmFsdWUpIHtcblx0XHRyZXR1cm4gdmFsdWUgPT09ICd0cnVlJyA/IHRydWUgOiAodmFsdWUgPT09ICdmYWxzZScgPyBmYWxzZSA6IHZhbHVlKTtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIGdldFRpbGVQcm9wZXJ0aWVzKHRpbGVzZXQsIHRpbGVJZCkge1xuXHRsZXQgcHJvcGVydGllcztcblx0aWYgKF8uaXNVbmRlZmluZWQodGlsZXNldC50aWxlcHJvcGVydGllcykgfHxcblx0XHRfLmlzVW5kZWZpbmVkKHRpbGVzZXQudGlsZXByb3BlcnRpZXNbdGlsZUlkXSkpIHtcblx0XHRwcm9wZXJ0aWVzID0ge307XG5cdH0gZWxzZSB7XG5cdFx0cHJvcGVydGllcyA9IHRpbGVzZXQudGlsZXByb3BlcnRpZXNbdGlsZUlkXTtcblx0fVxuXG5cdHJldHVybiBjb252ZXJ0VG9Cb29scyhwcm9wZXJ0aWVzKTtcbn1cblxuZnVuY3Rpb24gZ2VuVGlsZXNldCh0aWxlc2V0KSB7XG5cdHRpbGVzZXQgPSBfLmV4dGVuZCh7fSwgdGlsZXNldCk7XG5cdHRpbGVzZXQuaW1hZ2UgPSB0aWxlc2V0LmltYWdlLnJlcGxhY2UoJy4uLycsICcnKTtcblxuXHR0aWxlc2V0Lm51bVRpbGVzV2lkdGggPSBNYXRoLmZsb29yKHRpbGVzZXQuaW1hZ2VoZWlnaHQgLyB0aWxlc2V0LnRpbGVoZWlnaHQpO1xuXHR0aWxlc2V0Lm51bVRpbGVzSGVpZ2h0ID0gTWF0aC5mbG9vcih0aWxlc2V0LmltYWdld2lkdGggLyB0aWxlc2V0LnRpbGV3aWR0aCk7XG5cdHRpbGVzZXQudGlsZWNvdW50ID0gdGlsZXNldC5udW1UaWxlc1dpZHRoICogdGlsZXNldC5udW1UaWxlc0hlaWdodDtcblx0dGlsZXNldC5sYXN0Z2lkID0gdGlsZXNldC5maXJzdGdpZCArIHRpbGVzZXQudGlsZWNvdW50O1xuXG5cdHRpbGVzZXQudGlsZXMgPSBfKF8ucmFuZ2UodGlsZXNldC5maXJzdGdpZCwgdGlsZXNldC5sYXN0Z2lkKSlcblx0XHQubWFwKGZ1bmN0aW9uKHRpbGVJZCkge1xuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0Z2lkOiB0aWxlSWQsXG5cdFx0XHRcdHByb3BlcnRpZXM6IGdldFRpbGVQcm9wZXJ0aWVzKHRpbGVzZXQsIHRpbGVJZCAtIHRpbGVzZXQuZmlyc3RnaWQpLFxuXHRcdFx0XHR4OiAodGlsZUlkIC0gdGlsZXNldC5maXJzdGdpZCkgJSB0aWxlc2V0Lm51bVRpbGVzV2lkdGgsXG5cdFx0XHRcdHk6IE1hdGguZmxvb3IoKHRpbGVJZCAtIHRpbGVzZXQuZmlyc3RnaWQpIC8gdGlsZXNldC5udW1UaWxlc0hlaWdodClcblx0XHRcdH07XG5cdFx0fSlcblx0XHQucmVkdWNlKGZ1bmN0aW9uKGFjY3VtLCB0aWxlKSB7XG5cdFx0XHRhY2N1bVt0aWxlLmdpZF0gPSB0aWxlO1xuXHRcdFx0cmV0dXJuIGFjY3VtO1xuXHRcdH0sIHt9KTtcblx0cmV0dXJuIHRpbGVzZXQ7XG59XG5cbmZ1bmN0aW9uIGdldEFzc2V0c0Zyb21MZXZlbChsZXZlbCkge1xuXHRyZXR1cm4gXy5tYXAobGV2ZWwudGlsZXNldHMsIGZ1bmN0aW9uKHRpbGVzZXQpIHtcblx0XHRyZXR1cm4gXy5leHRlbmQoe1xuXHRcdFx0cGF0aDogdGlsZXNldC5pbWFnZSxcblx0XHRcdGlkOiB0aWxlc2V0Lm5hbWUsXG5cdFx0XHR0aWxlRGltZW5zaW9uczoge1xuXHRcdFx0XHR4OiB0aWxlc2V0Lm51bVRpbGVzV2lkdGgsXG5cdFx0XHRcdHk6IHRpbGVzZXQubnVtVGlsZXNIZWlnaHQsXG5cdFx0XHRcdHdpZHRoOiB0aWxlc2V0LnRpbGV3aWR0aCxcblx0XHRcdFx0aGVpZ2h0OiB0aWxlc2V0LnRpbGVoZWlnaHQsXG5cdFx0XHRcdGJhc2VJZDogdGlsZXNldC5maXJzdGdpZFxuXHRcdFx0fVxuXHRcdH0sIHRpbGVzZXQpO1xuXHR9KTtcbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=